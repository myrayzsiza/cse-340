<%- include('../partials/header') %>
<div class="container my-5">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h3>Manage Users</h3>
        </div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Type</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% accounts.forEach(account => { %>
                <tr id="account-<%= account.account_id %>">
                  <td><%= account.account_id %></td>
                  <td><%= account.account_firstname %> <%= account.account_lastname %></td>
                  <td><%= account.account_email %></td>
                  <td><%= account.account_type %></td>
                  <td>
                    <select class="form-select role-select" data-account-id="<%= account.account_id %>" <%= account.account_id === parseInt(req.res.locals.accountData?.account_id) ? 'disabled' : '' %>>
                      <% roles.forEach(role => { %>
                        <option value="<%= role.role_id %>" <%= account.role_id === role.role_id ? 'selected' : '' %>>
                          <%= role.role_name %>
                        </option>
                      <% }); %>
                    </select>
                  </td>
                  <td>
                    <% if (account.account_id !== req.res.locals.accountData?.account_id) { %>
                      <button
                        class="btn btn-danger btn-sm delete-user"
                        data-account-id="<%= account.account_id %>"
                        onclick="deleteUser(<%= account.account_id %>)"
                      >
                        Delete
                      </button>
                    <% } else { %>
                      <span class="text-muted">-</span>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Update user role
  document.querySelectorAll(".role-select").forEach((select) => {
    select.addEventListener("change", async function () {
      const accountId = this.dataset.accountId;
      const roleId = this.value;

      try {
        const response = await fetch("/admin/users/role", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ userId: accountId, roleId: roleId }),
        });

        const result = await response.json();

        if (result.success) {
          alert("Role updated successfully!");
        } else {
          alert("Error: " + result.message);
          location.reload();
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An error occurred");
        location.reload();
      }
    });
  });

  function deleteUser(accountId) {
    if (confirm("Are you sure you want to delete this user account? This cannot be undone.")) {
      fetch(`/admin/users/${accountId}`, {
        method: "DELETE",
      })
        .then((response) => response.json())
        .then((result) => {
          if (result.success) {
            document.getElementById(`account-${accountId}`).remove();
            alert("User deleted successfully");
          } else {
            alert("Error: " + result.message);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred");
        });
    }
  }
</script>
<%- include('../partials/footer') %>
